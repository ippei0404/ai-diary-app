import streamlit as st
from openai import OpenAI
import gspread
import pandas as pd
from datetime import datetime

# ===============================================
# ç”»é¢ã®ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
# ===============================================
st.set_page_config(page_title="AIæ—¥è¨˜ & æ„Ÿæƒ…åˆ†æ", page_icon="ğŸ“–")
st.title("ğŸ“– AIæ—¥è¨˜ & æ„Ÿæƒ…åˆ†æã‚¢ãƒ—ãƒª")

# ===============================================
# ğŸŒŸğŸŒŸğŸŒŸ Google Sheets èªè¨¼ã¨æ¥ç¶š ğŸŒŸğŸŒŸğŸŒŸ
# ===============================================
sh = None
try:
    # JSONãƒ•ã‚¡ã‚¤ãƒ«å: sheets_auth.json ã‚’æŒ‡å®š
    gc = gspread.service_account(filename="sheets_auth.json") 
    
    # æ¥ç¶šã™ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’æŒ‡å®š
    # ---!!! ã“ã“ã‚’ã‚ãªãŸã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã«ä¿®æ­£ã—ã¦ãã ã•ã„ !!!---
    spreadsheet_url = "https://docs.google.com/spreadsheets/d/1OCRBMTg2a39M_uVG-YmsMZMtdq4R5XzOv26nYx1ajHQ/edit?gid=0#gid=0" 
    # ----------------------------------------------------------------------
    
    # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
    sh = gc.open_by_url(spreadsheet_url)
    worksheet = sh.sheet1 # 1æšç›®ã®ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨
    st.sidebar.success("âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ¥ç¶šã—ã¾ã—ãŸ")
    
except Exception as e:
    st.sidebar.error("âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼")
    st.sidebar.info("èªè¨¼JSONãƒ•ã‚¡ã‚¤ãƒ«ã®æœ‰ç„¡ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã€å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

# ===============================================
# ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼šæ—¥è¨˜ã®å…¥åŠ›ã‚¨ãƒªã‚¢ã¨APIã‚­ãƒ¼
# ===============================================

# APIã‚­ãƒ¼ã®å…¥åŠ›ï¼ˆå®‰å…¨ã®ãŸã‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§å…¥åŠ›ï¼‰
api_key = st.sidebar.text_input("OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password")

st.subheader("ğŸ“ ä»Šæ—¥ã®ãƒ¡ãƒ¢ï¼ˆé›‘ã§OKï¼ï¼‰")
user_input = st.text_area("ä¾‹ï¼šç–²ã‚ŒãŸã€‚ã§ã‚‚ãƒ©ãƒ¼ãƒ¡ãƒ³ç¾å‘³ã—ã‹ã£ãŸã€‚éƒ¨é•·ã®è©±ãŒé•·ã‹ã£ãŸã€‚", height=150)

# ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
if st.button("æ—¥è¨˜ã‚’ç”Ÿæˆï¼†åˆ†æã™ã‚‹"):
    if not api_key:
        st.error("å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼")
    elif not user_input:
        st.warning("æ—¥è¨˜ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼")
    elif not sh:
        st.error("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰ã«æ¥ç¶šã§ãã¦ã„ã¾ã›ã‚“ã€‚å·¦å´ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    else:
        # OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æº–å‚™
        client = OpenAI(api_key=api_key)

        with st.spinner("AIãŒåŸ·ç­†ä¸­...ğŸ¤–"):
            try:
                # AIã¸ã®æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
                system_prompt = """
                ã‚ãªãŸã¯ãƒ—ãƒ­ã®ãƒ©ã‚¤ã‚¿ãƒ¼å…¼å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã§ã™ã€‚
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œé›‘ãªæ—¥è¨˜ãƒ¡ãƒ¢ã€ã‚’å—ã‘å–ã‚Šã€ä»¥ä¸‹ã®2ã¤ã®å‡¦ç†ã‚’è¡Œã„ã€å¿…ãšä»¥ä¸‹ã®å‡ºåŠ›å½¢å¼ã«å¾“ã£ã¦ãã ã•ã„ã€‚

                1. ã€æ—¥è¨˜ã®æ¸…æ›¸ã€‘: èª­ã¿ã‚„ã™ãã€æƒ…ç·’ã‚ã‚‹ä¸å¯§ãªæ—¥æœ¬èªã®æ—¥è¨˜ã«ãƒªãƒ©ã‚¤ãƒˆã™ã‚‹ã€‚
                2. ã€æ„Ÿæƒ…åˆ†æã€‘: ãã®æ—¥è¨˜ã®ã€Œãƒã‚¸ãƒ†ã‚£ãƒ–åº¦ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰ã€ã‚’ã¤ã‘ã€å¿ƒç†åˆ†æã«åŸºã¥ã„ãŸã€Œä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆã€ã‚’æ·»ãˆã‚‹ã€‚

                å‡ºåŠ›å½¢å¼ã¯å¿…ãšä»¥ä¸‹ã®ã‚ˆã†ã«å³å¯†ã«å¾“ã£ã¦ãã ã•ã„ï¼š
                ---
                ã€æ¸…æ›¸ã•ã‚ŒãŸæ—¥è¨˜ã€‘
                ï¼ˆã“ã“ã«æ¸…æ›¸ã•ã‚ŒãŸæ–‡ç« ï¼‰

                ã€åˆ†æçµæœã€‘
                ğŸ“Š ãƒã‚¸ãƒ†ã‚£ãƒ–åº¦: ï¼ˆç‚¹æ•°ï¼‰/100
                ğŸ’¬ AIã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ: ï¼ˆã“ã“ã«ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
                ---
                """

                # AIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
                response = client.chat.completions.create(
                    model="gpt-4o-mini", # ã‚³ã‚¹ãƒˆã¨é€Ÿåº¦ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ãƒ¢ãƒ‡ãƒ«
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_input}
                    ]
                )

                # çµæœã®å–å¾—ã¨è¡¨ç¤º
                result_text = response.choices[0].message.content
                st.markdown("### âœ¨ ç”Ÿæˆçµæœ")
                st.info(result_text)

                # ğŸŒŸğŸŒŸğŸŒŸ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ä¿å­˜ ğŸŒŸğŸŒŸğŸŒŸ
                # æ—¥ä»˜ã€å…ƒã®ãƒ¡ãƒ¢ã€ç”Ÿæˆçµæœã€åˆ†æçµæœã‚’æŠ½å‡º
                today = datetime.now().strftime("%Y/%m/%d %H:%M:%S")
                
                # åˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’å–å¾—
                analysis_section = result_text.split("ã€åˆ†æçµæœã€‘")[1].strip() if "ã€åˆ†æçµæœã€‘" in result_text else "N/A"
                
                # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¡Œã‚’è¿½åŠ 
                worksheet.append_row([
                    today,          # æ—¥ä»˜
                    user_input,     # å…ƒã®ãƒ¡ãƒ¢
                    result_text,    # ç”Ÿæˆã•ã‚ŒãŸå…¨çµæœ
                    analysis_section# åˆ†æçµæœ
                ])
                st.success(f"æ—¥è¨˜ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸã€‚")
                # ğŸŒŸğŸŒŸğŸŒŸ ä¿å­˜å‡¦ç†çµ‚ã‚ã‚Š ğŸŒŸğŸŒŸğŸŒŸ

            except Exception as e:
                st.error(f"AIå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„: {e}")

st.markdown("---")
# ===============================================
# ğŸ“š éå»ã®æ—¥è¨˜è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³
# ===============================================
st.header("ğŸ“š éå»ã®æ—¥è¨˜")

if sh: # æ¥ç¶šãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤º
    try:
        # ã‚·ãƒ¼ãƒˆã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        data = worksheet.get_all_records()
        df = pd.DataFrame(data)

        if not df.empty:
            # æœ€æ–°ã®æ—¥è¨˜ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ä¸¦ã³æ›¿ãˆ
            df = df.iloc[::-1] 
            
            for index, row in df.iterrows():
                # åˆ†æçµæœã‹ã‚‰ãƒã‚¸ãƒ†ã‚£ãƒ–åº¦ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã€è¦‹å‡ºã—ã«ä½¿ç”¨
                analysis_parts = row['åˆ†æçµæœ'].split('\n')
                score_line = next((line for line in analysis_parts if 'ãƒã‚¸ãƒ†ã‚£ãƒ–åº¦' in line), "N/A")
                comment_line = next((line for line in analysis_parts if 'AIã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ' in line), "N/A")
                
                # ã‚¨ã‚­ã‚¹ãƒ‘ãƒ³ãƒ€ãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½œæˆ
                expander_title = f"ğŸ—“ï¸ {row['æ—¥ä»˜'].split(' ')[0]} - {score_line.split(':')[1].strip()}"
                
                with st.expander(expander_title):
                    st.markdown("#### âœ¨ æ¸…æ›¸ã•ã‚ŒãŸæ—¥è¨˜")
                    
                    # ç”Ÿæˆçµæœå…¨ä½“ã‹ã‚‰æ¸…æ›¸ã•ã‚ŒãŸæ—¥è¨˜éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
                    diary_entry = row['ç”Ÿæˆçµæœ'].split("ã€æ¸…æ›¸ã•ã‚ŒãŸæ—¥è¨˜ã€‘")[-1].split("ã€åˆ†æçµæœã€‘")[0].strip()
                    st.markdown(diary_entry)
                    
                    st.markdown("#### ğŸ’– æ„Ÿæƒ…åˆ†æ")
                    st.markdown(score_line)
                    st.markdown(comment_line)
                    
                    st.caption(f"**ï¼ˆå…ƒã®ãƒ¡ãƒ¢ï¼‰**ï¼š{row['å…ƒã®ãƒ¡ãƒ¢']}")

        else:
            st.info("ã¾ã æ—¥è¨˜ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ—¥è¨˜ã‚’ç”Ÿæˆã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚")
            
    except Exception as e:
        st.error(f"éå»ã®æ—¥è¨˜èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚{e}")